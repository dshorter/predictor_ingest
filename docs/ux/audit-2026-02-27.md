# UI Implementation Audit — 2026-02-27

Full codebase audit of `web/` against the UX spec documents in `docs/ux/`.
This supersedes the January 31 gap snapshot (`v1-gaps.md`) with a deeper structural analysis.

**Audited:** 2026-02-27T~15:00 UTC
**Scope:** All files in `web/` (desktop + mobile), all docs in `docs/ux/`
**Method:** Line-by-line read of every CSS, JS, and HTML file; cross-referenced against every spec document

---

## Executive Summary

The UI implementation is **significantly more disciplined than most production web applications**.
The codebase doesn't just follow the spec — in several areas it exceeds it. The design token system
is real and actually consumed. The mobile implementation is a genuine parallel build, not a responsive
hack. The Cytoscape visual encoding is research-backed and well-tuned.

That said, there are real gaps. Some are dead code (features wired in CSS but never activated in JS),
some are spec features that were never built (context menu, colorblind mode), and some are polish
items that separate "works correctly" from "feels right."

**Overall assessment:** The foundation is strong enough that gap remediation and polish are
straightforward sequencing problems, not architectural ones.

---

## What's Strong (honest observations)

### 1. The design token system is real

`tokens.css` (234 lines) defines every spacing value, color, shadow, radius, transition, z-index,
and typography token used across the application. The component CSS files actually consume these
tokens — there are no rogue hardcoded hex values or pixel counts leaking through. This is rarer
than it should be in production codebases.

**Evidence:** Every component file (`button.css`, `panel.css`, `toolbar.css`, etc.) references
`var(--space-*)`, `var(--gray-*)`, `var(--shadow-*)` consistently. Dark mode works because the
token layer handles it — `[data-theme="dark"]` overrides in `tokens.css` swap values, and
everything downstream just works.

### 2. The Cytoscape visual encoding is sophisticated

`styles.js` (326 lines) implements a multi-dimensional visual encoding:

- **Node size:** base 30px × velocity multiplier (1x–2.5x) × recency boost (7d=1.5x → 30d+=1.0x) × degree multiplier (log-based), clamped 20–80px
- **Node opacity:** lastSeen-based fade (7d=1.0, 90d=0.6, older=0.5)
- **Edge width:** confidence-mapped (0→0.5px, 1→4px)
- **Edge style:** asserted=solid, inferred=dashed, hypothesis=dotted
- **Border encoding:** hover (blue, thick), selected (blue, thicker + overlay), search match (yellow), new (green double-line)
- **Label rendering:** white text outline for contrast, size scales with node

This isn't a default "throw nodes on screen" implementation. The visual encoding carries
information density without cluttering.

### 3. The mobile build is a real implementation

1,590 lines across 5 dedicated files — not media query overrides on the desktop code:

- `mobile/css/mobile.css` (1,170 lines): Bottom-up overlay paradigm, 48px touch targets, safe area insets, full-screen modals
- `mobile/js/app-mobile.js` (613 lines): Tap-only events, lower scale thresholds, no minimap
- `mobile/js/panels-mobile.js` (415 lines): Bottom sheet detail/evidence panels
- `mobile/js/touch.js` (275 lines): Momentum-based swipe gestures with velocity snapping

The mobile UI achieves feature parity with desktop through paradigm-appropriate patterns
(bottom sheets instead of sidebars, full-screen modals instead of panels, swipe instead of hover).

### 4. Accessibility is structurally integrated, not bolted on

- ARIA live region for screen reader announcements
- `aria-label` attributes on interactive elements throughout
- Keyboard navigation with directional scoring (arrow keys traverse neighbors by angle)
- Focus management on panel open/close
- `role="application"` on the graph container
- `tabindex` management for panel trap/release

### 5. The layout algorithm is research-backed

`layout.js` (406 lines) implements ratio-based parameter scaling:

- Reference calibration: 37 nodes / 31 edges (trending view)
- Node separation, repulsion, edge length, elasticity, gravity all scale against reference
- Scaling uses appropriate functions (linear for spacing, quadratic for repulsion, inverse for elasticity)
- Post-layout `cy.fit()` deferred to preserve natural spacing
- Iteration count scales with graph size (100 nodes→3500, 500→4500, 1000→5000)
- Debug helpers exposed on `window` for runtime tuning

### 6. The CSS architecture is modular and load-order-aware

`main.css` imports in explicit order with comments explaining why:
1. Tokens (foundation)
2. Reset (normalize)
3. Base (typography)
4. Components (7 files)
5. Graph-specific (2 files)
6. Utilities (override layer)

Each component file is self-contained. No file exceeds 400 lines. Naming is consistent
(BEM-lite: `.panel-close`, `.filter-section`, `.toolbar-group`).

---

## Spec vs. Implementation Gap Matrix

### Features marked V1 in spec but not fully implemented

| Feature | Spec source | Code status | Gap type | Effort |
|---------|-------------|-------------|----------|--------|
| "What's new" node highlight | `visual-encoding.md`, `implementation.md` | CSS `.new` class defined, `isNewNode()` exists, **never applied** | Dead code | Low (~10 lines) |
| Double-click behaviors | `interaction.md` | `dbltap` handler not wired; `expandNeighbors()` exists | Dead code | Low (~15 lines) |
| Context menu (right-click) | `interaction.md` | Extension listed in spec, not loaded or initialized | Not built | Medium |
| Custom date picker | `search-filter.md` | Preset buttons only (7d/30d/90d/All) | Partial | Medium |
| Colorblind mode | `accessibility.md` | No alternate palette, no toggle | Not built | Medium |
| Reduced motion | `accessibility.md` | `reset.css` mentions it, not applied to layout/transitions/tooltips | Not built | Low |
| Gzipped JSON | `performance.md`, `implementation.md` | Plain JSON served | Not built | Low (build step) |
| Label collision detection | `visual-encoding.md` | Zoom + importance heuristic only, no bounding-box check | Simplified | Medium–High |

### Features that work but have rough edges

| Feature | Issue | Location |
|---------|-------|----------|
| Kind toggles | Hypothesis unchecked by default — intentional? Not documented as a design decision | `filter.js:18` |
| Detail panel grid | Uses inline styles instead of CSS classes for the 4-cell stats grid | `panels.js` |
| View switching | No transition state between views — graph disappears and reappears | `app.js` |
| Mobile CSS size | 1,170 lines in a single file — could benefit from splitting | `mobile/css/mobile.css` |
| Help content | `glossary.html` is 52.5KB — unclear if hand-maintained or generated | `help/glossary.html` |

### Spec features correctly deferred to V2

These are NOT gaps — they were intentionally scoped out and should stay that way:

- Preset layout (stored positions)
- Hybrid layout ("integrate new" nodes)
- Edge bundling
- Node expansion (load on demand)
- Time-lapse animation / timeline scrubber
- Lazy loading details
- WebGL renderer
- User preferences / saved views

---

## Structural Observations

### Things the spec doesn't cover but the code handles well

1. **Navigator minimap** — Fully implemented with toggle, resize handling, and panel-aware positioning. The spec originally listed this as V2; code delivered it in V1.

2. **Mobile detection and redirect** — `index.html` includes a script that redirects small screens to `/mobile/`. Clean approach, avoids responsive CSS complexity.

3. **Scale-aware layout scaling** — `layout.js` adapts fcose parameters based on actual graph density. The spec describes fcose usage but doesn't prescribe the scaling algorithm. The implementation goes further.

4. **Cache-busting** — Script tags in HTML use `?v=` parameters. Simple but effective for static deployment.

5. **Help system** — In-app help with tabs, accordion, glossary — fully built. The spec (`in-app-help-plan.md`) describes the plan; the implementation matches.

### Things the code could do better (not bugs, not gaps — polish)

1. **View switch transitions** — Currently abrupt. A loading overlay during data fetch + layout would smooth this.

2. **Panel inline styles** — The detail panel stats grid uses `style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px"` instead of a CSS class. Small but breaks the "all styling via tokens" discipline.

3. **No "What's New" temporal mode** — The toolbar has a view selector but no toggle for "highlight everything new." The `.new` class exists but is passive. An active temporal highlight mode would be a natural addition.

4. **Desktop touch targets** — Some toolbar buttons are 36px. The spec recommends ≥44px for accessibility. Mobile correctly uses 48px.

---

## File Inventory

### Desktop (10 JS files, ~3,000 lines total)

| File | Lines | Purpose |
|------|-------|---------|
| `app.js` | 683 | Init, state, event routing, theme |
| `styles.js` | 326 | Cytoscape visual encoding |
| `graph.js` | 237 | Data loading, meta handling, scale checks |
| `filter.js` | 407 | GraphFilter class, UI sync |
| `search.js` | 128 | Search, highlighting, dimming |
| `panels.js` | 318 | Detail + evidence panels |
| `layout.js` | 406 | fcose + cose layout, ratio scaling |
| `tooltips.js` | 185 | Hover tooltips with positioning |
| `help.js` | 253 | Help panel, tabs, accordion |
| `utils.js` | 269 | Formatters, overlays, a11y helpers |

### Desktop CSS (12 files, ~1,900 lines total)

| File | Lines | Purpose |
|------|-------|---------|
| `tokens.css` | 234 | Design foundation |
| `reset.css` | 89 | Browser normalize |
| `base.css` | 144 | Typography, links |
| `main.css` | 37 | Import orchestration |
| `utilities.css` | 139 | Utility classes |
| `button.css` | 127 | Button variants |
| `input.css` | 140 | Form controls |
| `badge.css` | 135 | Semantic tags |
| `panel.css` | 184 | Sidebar/bottom panels |
| `toolbar.css` | 174 | Fixed toolbar |
| `tooltip.css` | 151 | Hover tooltips |
| `help-panel.css` | 391 | Help sidebar |
| `cytoscape.css` | 100 | Graph container |
| `overlays.css` | 174 | Loading/error states |

### Mobile (3 JS files + 1 CSS, ~2,470 lines total)

| File | Lines | Purpose |
|------|-------|---------|
| `app-mobile.js` | 613 | Mobile init, events |
| `panels-mobile.js` | 415 | Bottom sheet panels |
| `touch.js` | 275 | Swipe gesture handling |
| `mobile.css` | 1,170 | All mobile styles |

### HTML (3 files)

| File | Approx. lines | Purpose |
|------|---------------|---------|
| `index.html` | 292 | Desktop shell |
| `mobile/index.html` | 311 | Mobile shell |
| `help/glossary.html` | ~1,500 | Standalone glossary |

### Test data

6 directories under `web/data/graphs/` with 4 views each (trending, claims, mentions, dependencies):
`latest/`, `live/`, `small/` (15 nodes), `medium/` (150 nodes), `large/` (500 nodes), `stress/` (2000 nodes).

---

## Recommendations (sequenced)

See companion documents:
- **[gap-remediation-plan.md](gap-remediation-plan.md)** — Ordered sequence for closing spec gaps
- **[polish-strategy.md](polish-strategy.md)** — Visual and interaction polish plan
- **[ui-testing-strategy.md](ui-testing-strategy.md)** — Testing approach for the UI layer
